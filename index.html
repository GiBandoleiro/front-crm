<!DOCTYPE html>
<html lang="pt-BR" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM Central – Kanban Pro</title>

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Litepicker for Date Picking -->
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" />

  <!-- Lucide Icons (fixed version) -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.309.0/dist/umd/lucide.min.js"></script>

  <!-- SortableJS for Drag & Drop (fixed version) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <!-- Day.js for Date Manipulation -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/pt-br.js"></script>

  <!-- Custom Styles and Tailwind Config -->
  <style type="text/tailwindcss">
    @layer base {
      :root {
        --color-base: #F8FAFC;
        --color-panel: #FFFFFF;
        --color-text: #0F172A;
        --color-secondary: #475569;
        --color-border: #E2E8F0;
        --color-blue: #3B82F6;
        --color-hover: #f1f5f9;
      }
      .dark {
        --color-base: #0F172A;
        --color-panel: #1E293B;
        --color-text: #F8FAFC;
        --color-secondary: #94A3B8;
        --color-border: #334155;
        --color-blue: #3B82F6;
        --color-hover: #334155;
      }
      body {
        @apply bg-base text-text font-sans antialiased;
      }
      .kanban-card.sortable-ghost {
        @apply !bg-blue-500/20 border-blue-500 opacity-50;
      }
      .kanban-list.sortable-ghost {
        @apply !bg-slate-700/50 rounded-2xl;
        transform: rotate(2deg);
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }
      /* Litepicker dark theme */
      .dark .litepicker {
        background-color: #1E293B !important;
        border-color: #334155 !important;
        color: #F8FAFC !important;
      }
      .dark .litepicker .container__months .month-item-header, .dark .litepicker .container__tooltip {
        color: #F8FAFC !important;
      }
       .dark .litepicker .container__months .month-item .day-item:not(.is-start-date):not(.is-end-date):hover {
         background-color: #334155 !important;
       }
       .dark .litepicker .month-item-week-day {
         color: #94A3B8 !important;
       }
       .dark .litepicker, .dark .litepicker .container__footer {
         background-color: #1E293B !important;
       }
       .dark .litepicker .button-cancel {
         color: #F8FAFC !important;
       }
      /* List View Specific Styles */
       .list-view-row:hover {
         @apply bg-hover;
       }
      /* Ensure empty list card area is droppable */
       .list-cards {
         @apply min-h-[80px]; /* Added minimum height */
       }
       /* Log Modal Style */
       #logs-content-area {
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
       }
       /* List Actions Dropdown */
       .list-actions-dropdown {
         @apply absolute top-full right-0 mt-1 w-40 bg-panel border border-border rounded-lg shadow-xl p-2 z-20;
       }
    }
  </style>
  <script>
    // Tailwind Configuration
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
          colors: {
            base: 'var(--color-base)',
            panel: 'var(--color-panel)',
            text: 'var(--color-text)',
            secondary: 'var(--color-secondary)',
            border: 'var(--color-border)',
            brand: {
              blue: 'var(--color-blue)',
            },
            hover: 'var(--color-hover)',
          },
        },
      },
    }
  </script>
</head>

<body class="overflow-hidden">

  <div id="app" class="flex h-screen w-screen bg-base">
    <!-- Sidebar -->
    <aside class="w-64 flex-shrink-0 bg-panel border-r border-border flex flex-col">
      <div class="h-16 flex items-center px-6 border-b border-border">
        <i data-lucide="kanban-square" class="text-brand-blue"></i>
        <h1 class="ml-2 text-xl font-bold text-text">CRM Central</h1>
      </div>
      <nav id="sidebar-nav" class="flex-1 p-4 space-y-1">
        <!-- Navigation items will be injected here by JS -->
      </nav>

      <!-- Logs Button -->
      <div class="p-4 border-t border-border">
        <button id="show-logs-btn" class="w-full flex items-center justify-start px-3 py-2 rounded-lg text-secondary hover:bg-hover hover:text-text font-medium transition-colors">
            <i data-lucide="terminal" class="h-5 w-5 mr-3"></i>
            <span>Logs do Sistema</span>
        </button>
      </div>

      <div class="p-4 border-t border-border">
        <div class="flex items-center">
          <img class="h-10 w-10 rounded-full object-cover" src="https://i.pravatar.cc/150?u=AC" alt="User Avatar">
          <div class="ml-3">
            <p class="text-sm font-semibold text-text">Ana Costa</p>
            <p class="text-xs text-secondary">ac@crmcentral.com</p>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Views Container -->
      <main id="views-container" class="flex-1 overflow-auto p-6">

        <!-- Kanban View (Now contains Board, List and Calendar) -->
        <div id="kanban-view" class="view hidden h-full flex flex-col">
          <!-- View header now includes search and previous header buttons -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-4"> <!-- Wrapper for Title and Search -->
              <div>
                <!-- View Title -->
                <h2 id="view-title" class="text-2xl font-bold text-text mb-1">Kanban de Leads</h2>
                <p class="text-sm text-secondary">Gerencie seus leads por etapas do funil.</p>
              </div>
              <!-- Search -->
              <div class="relative">
                  <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-secondary"></i>
                  <input id="global-search" type="text" placeholder="Buscar leads, empresas... (Pressione /)" class="w-72 bg-base border border-border rounded-lg pl-9 pr-4 py-1.5 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none transition-all">
              </div>
            </div>
            <!-- Buttons moved here -->
            <div class="flex items-center space-x-3 relative">
                 <button id="refresh-data-btn" class="h-9 w-9 flex items-center justify-center rounded-lg text-secondary hover:bg-hover hover:text-text transition-colors" title="Atualizar dados">
                   <i data-lucide="refresh-cw" class="h-5 w-5"></i>
                 </button>
                 <button id="theme-toggle" class="h-9 w-9 flex items-center justify-center rounded-lg text-secondary hover:bg-hover hover:text-text transition-colors" title="Alternar tema">
                     <i data-lucide="sun" class="h-5 w-5 block dark:hidden"></i>
                     <i data-lucide="moon" class="h-5 w-5 hidden dark:block"></i>
                 </button>
                <button id="main-view-toggle" class="h-9 px-4 flex items-center justify-center rounded-lg bg-panel border border-border text-sm font-semibold hover:bg-hover">
                    <i data-lucide="list" class="h-4 w-4 mr-2"></i>Visão: Lista
                </button>
                <button id="calendar-view-toggle" class="h-9 px-4 flex items-center justify-center rounded-lg bg-panel border border-border text-sm font-semibold hover:bg-hover">
                    <i data-lucide="calendar" class="h-4 w-4 mr-2"></i>Calendário
                </button>
                <button id="filter-btn" class="h-9 px-4 flex items-center justify-center rounded-lg bg-panel border border-border text-sm font-semibold hover:bg-hover relative">
                    <i data-lucide="filter" class="h-4 w-4 mr-2"></i>
                    Filtros
                    <span id="filter-indicator" class="absolute -top-1 -right-1 h-2 w-2 rounded-full bg-brand-blue hidden"></span>
                </button>
                 <button id="add-new-lead-header" class="h-9 px-4 flex items-center justify-center rounded-lg bg-brand-blue text-white text-sm font-semibold hover:bg-blue-700 transition-colors">
                     <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                     Novo Lead
                 </button>
                <div id="filter-popup" class="absolute top-full right-0 mt-2 w-72 bg-panel border border-border rounded-2xl shadow-xl p-4 z-10 hidden">
                    <!-- Filter content will be injected here -->
                </div>
            </div>
          </div>

          <!-- Kanban Board Wrapper -->
          <!-- items-stretch makes columns stretch -->
          <div id="kanban-board-wrapper" class="flex-1 overflow-hidden -mx-6">
            <div id="kanban-board" class="flex gap-6 overflow-x-auto pb-4 px-6 items-stretch h-full">
              <!-- Kanban lists will be injected here -->
            </div>
          </div>

          <!-- List View Wrapper (hidden by default) -->
          <div id="list-view-wrapper" class="hidden flex-1 overflow-auto">
            <table class="w-full text-sm text-left">
              <thead class="text-xs text-secondary uppercase bg-base sticky top-0">
                <tr>
                  <th scope="col" class="px-6 py-3">Nome</th>
                  <th scope="col" class="px-6 py-3">Empresa</th>
                  <th scope="col" class="px-6 py-3">Etapa</th>
                  <th scope="col" class="px-6 py-3">Origem</th>
                  <th scope="col" class="px-6 py-3">Responsáveis</th>
                  <th scope="col" class="px-6 py-3">Criação</th>
                  <th scope="col" class="px-6 py-3"><span class="sr-only">Ações</span></th>
                </tr>
              </thead>
              <tbody id="list-view-body" class="bg-panel divide-y divide-border">
                <!-- List items will be injected here -->
              </tbody>
            </table>
          </div>


          <!-- Calendar Wrapper (hidden by default) -->
          <div id="calendar-wrapper" class="hidden h-full flex flex-col flex-1">
             <div class="flex items-center justify-between mb-4">
               <div class="flex items-center gap-2">
                 <button id="calendar-prev" class="h-9 w-9 flex items-center justify-center rounded-lg text-secondary hover:bg-hover hover:text-text transition-colors"><i data-lucide="chevron-left" class="h-5 w-5"></i></button>
                 <h3 id="calendar-title" class="text-xl font-bold text-text text-center w-48"></h3>
                 <button id="calendar-next" class="h-9 w-9 flex items-center justify-center rounded-lg text-secondary hover:bg-hover hover:text-text transition-colors"><i data-lucide="chevron-right" class="h-5 w-5"></i></button>
               </div>
               <!-- Added date selector and 'Today' button -->
               <div class="flex items-center gap-2">
                   <!-- Default to Next Contact -->
                   <select id="calendar-data-source" class="h-9 bg-panel border border-border rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none">
                       <option value="createdAt">Data de Criação</option>
                       <option value="nextContactDate" selected>Próximo Contato</option>
                   </select>
                   <button id="calendar-today" class="h-9 px-4 text-sm font-semibold rounded-lg text-secondary bg-panel border border-border hover:bg-hover">Hoje</button>
               </div>
             </div>
             <div id="calendar-grid-header" class="grid grid-cols-7"></div>
             <div id="calendar-grid" class="flex-1 grid grid-cols-7 grid-rows-5 gap-px bg-border border-t border-l border-border rounded-lg overflow-hidden">
               <!-- Calendar days injected here -->
             </div>
          </div>

        </div>

        <!-- Other Views (Mocks) -->
        <div id="contacts-view" class="view hidden"></div>
        <div id="companies-view" class="view hidden"><div class="bg-panel p-8 rounded-2xl"><h1 class="text-2xl font-bold">Empresas (Mock)</h1></div></div>
        <div id="reports-view" class="view hidden"><div class="bg-panel p-8 rounded-2xl"><h1 class="text-2xl font-bold">Relatórios (Mock)</h1></div></div>
        <div id="settings-view" class="view hidden"><div class="bg-panel p-8 rounded-2xl"><h1 class="text-2xl font-bold">Configurações (Mock)</h1></div></div>

      </main>
    </div>

    <!-- Card Detail Drawer -->
    <div id="card-drawer" class="fixed top-0 right-0 h-full w-[600px] bg-panel border-l border-border shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col">
      <!-- Drawer content will be injected here -->
    </div>
    <div id="drawer-overlay" class="fixed inset-0 bg-black/60 z-40 hidden transition-opacity duration-300"></div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-[100] space-y-3"></div>

    <!-- Modal Container -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 z-[100] hidden items-center justify-center transition-opacity duration-300 flex"> <!-- Fixed: Added 'flex' -->
      <div id="modal-box" class="bg-panel rounded-2xl shadow-xl p-8 w-full max-w-md transform scale-95 transition-transform duration-300">
        <!-- Modal content here -->
      </div>
    </div>

    <!-- Container for list actions dropdown (to avoid overflow issues) -->
    <div id="list-actions-container" class="absolute z-30"></div>

  </div>

  <script>
    // FIX: Wrap entire script in a window.onload to ensure all libs are loaded
    window.onload = () => {

      // --- SETUP ---
      dayjs.extend(dayjs_plugin_relativeTime);
      dayjs.extend(dayjs_plugin_isoWeek);
      dayjs.extend(dayjs_plugin_isBetween);
      dayjs.locale('pt-br');

      // FIX: Make App object global by attaching it to window
      window.App = {
        // --- STATE & CONFIG ---
        state: {},
        logs: [], // For API logs
        elements: {
          app: document.getElementById('app'),
          sidebarNav: document.getElementById('sidebar-nav'),
          viewTitle: document.getElementById('view-title'), // This element remains, but it's populated differently now
          viewsContainer: document.getElementById('views-container'),
          themeToggle: document.getElementById('theme-toggle'), // Moved
          kanbanView: document.getElementById('kanban-view'),
          kanbanBoard: document.getElementById('kanban-board'),
          kanbanBoardWrapper: document.getElementById('kanban-board-wrapper'),
          listViewWrapper: document.getElementById('list-view-wrapper'),
          listViewBody: document.getElementById('list-view-body'),
          calendarWrapper: document.getElementById('calendar-wrapper'),
          mainViewToggle: document.getElementById('main-view-toggle'),
          calendarViewToggle: document.getElementById('calendar-view-toggle'), // Renamed from kanban-view-toggle
          cardDrawer: document.getElementById('card-drawer'),
          drawerOverlay: document.getElementById('drawer-overlay'),
          toastContainer: document.getElementById('toast-container'),
          modalOverlay: document.getElementById('modal-overlay'),
          modalBox: document.getElementById('modal-box'),
          globalSearch: document.getElementById('global-search'),
          addNewLeadHeaderBtn: document.getElementById('add-new-lead-header'), // Moved
          filterBtn: document.getElementById('filter-btn'),
          filterPopup: document.getElementById('filter-popup'),
          filterIndicator: document.getElementById('filter-indicator'),
          refreshDataBtn: document.getElementById('refresh-data-btn'), // Moved
          showLogsBtn: document.getElementById('show-logs-btn'),
          calendar: {
              grid: document.getElementById('calendar-grid'),
              gridHeader: document.getElementById('calendar-grid-header'),
              title: document.getElementById('calendar-title'),
              prevBtn: document.getElementById('calendar-prev'),
              nextBtn: document.getElementById('calendar-next'),
              todayBtn: document.getElementById('calendar-today'),
              calendarDataSource: document.getElementById('calendar-data-source'),
          },
          listActionsContainer: document.getElementById('list-actions-container'), // New container
        },
        config: {
          routes: [
            { hash: '#/kanban', view: 'kanban-view', title: 'Kanban', icon: 'kanban-square' },
            { hash: '#/contacts', view: 'contacts-view', title: 'Contatos', icon: 'users' },
            { hash: '#/companies', view: 'companies-view', title: 'Empresas', icon: 'building-2' },
            { hash: '#/reports', view: 'reports-view', title: 'Relatórios', icon: 'bar-chart-2' },
            { hash: '#/settings', view: 'settings-view', title: 'Configurações', icon: 'settings' },
          ],
          currentDate: dayjs(),
          activeLitepicker: null,
          previousMainView: 'board', // To remember the view when switching to calendar
          openListActionsDropdown: null, // Track which dropdown is open
        },

        // --- INITIALIZATION ---
        init() {
          this.initTheme();
          this.loadState();
          this.addLog('Aplicação iniciada, estado carregado.');
          this.initRouter();
          this.renderSidebar();
          this.attachEventListeners();
          lucide.createIcons();
        },

        // --- LOGGING & API MOCK ---
        addLog(message, type = 'info') {
            const time = dayjs().format('HH:mm:ss');
            console.log(`[LOG ${time}]: ${message}`);
            this.logs.push({ message, type, time: new Date().toISOString() });
            if (this.logs.length > 100) this.logs.shift(); // Keep logs reasonable
            this.renderLogsInModal(); // Update modal if open
        },

        // Mock API PUT
        apiPutLeads(reason) {
            this.addLog(`[PUT /crm/leads] Salvando... (Motivo: ${reason})`);
            // Simulação de salvamento instantâneo no localStorage
            this.saveState();
            this.addLog(`[PUT /crm/leads] Estado salvo com sucesso.`, 'success');

            // Imediatamente dispara o GET
            this.apiGetLeads(`Atualização pós-${reason}`);
        },

        // Mock API GET
        apiGetLeads(reason = 'Atualização manual') {
            this.addLog(`[GET /crm/leads] Puxando dados... (Motivo: ${reason})`);
            const spinIcon = this.elements.refreshDataBtn.querySelector('i');
            if(spinIcon) spinIcon.classList.add('animate-spin');

            setTimeout(() => { // Simular atraso de rede
                this.loadState(); // O "load" real
                this.addLog(`[GET /crm/leads] Dados recebidos.`, 'success');
                this.handleRouteChange(); // Re-renderizar tudo
                if(spinIcon) spinIcon.classList.remove('animate-spin');
            }, 800);
        },

        // --- STATE MANAGEMENT ---
        uid() {
          return Date.now().toString(36) + Math.random().toString(36).substring(2);
        },

        loadState() {
          const storedState = localStorage.getItem('crmCentral');
          if (storedState) {
            this.state = JSON.parse(storedState);
          } else {
            this.seedState();
          }
           // Ensure filter/sort/view state exists
          this.state.viewState = this.state.viewState || {
            filters: { origin: [], labels: [], dateRange: { start: null, end: null } },
            sortBy: 'default',
            activeMainView: 'board', // 'board' or 'list' or 'calendar'
            calendarDataSource: 'nextContactDate' // Ensure default exists
          };
          this.config.previousMainView = ['board', 'list'].includes(this.state.viewState.activeMainView) ? this.state.viewState.activeMainView : 'board';

          // Make sure calendar default reflects in state if not explicitly set
           if (!this.state.viewState.calendarDataSource) {
             this.state.viewState.calendarDataSource = 'nextContactDate';
           }
           // Update the dropdown visually if the element exists
           if (this.elements.calendar.calendarDataSource) {
             this.elements.calendar.calendarDataSource.value = this.state.viewState.calendarDataSource;
           }
        },


        saveState() {
          // This is the only function that writes to localStorage
          localStorage.setItem('crmCentral', JSON.stringify(this.state));
        },

        updateCard(cardId, updates) {
            const board = this.state.boards[0];
            const cardIndex = board.cards.findIndex(c => c.id === cardId);
            if (cardIndex !== -1) {
                // Add an edit entry to timeline
                if(!updates.timeline) {
                    const oldCard = board.cards[cardIndex];
                    const changedKeys = Object.keys(updates).filter(k => oldCard[k] !== updates[k] && k !== 'attributes' && k !== 'notes'); // Don't log attr/note changes as single "field"
                    if(changedKeys.length > 0 && !changedKeys.includes('listId')) { // listId move is handled separately
                         board.cards[cardIndex].timeline.push({ t: 'edited', field: changedKeys.join(', '), at: new Date().toISOString() });
                    }
                }

                board.cards[cardIndex] = { ...board.cards[cardIndex], ...updates };
                const contactIndex = this.state.contacts.findIndex(c => c.id === cardId);
                if(contactIndex !== -1) {
                    this.state.contacts[contactIndex] = { ...this.state.contacts[contactIndex], ...updates };
                }

                // Call API PUT
                this.apiPutLeads(`Atualização de card: ${Object.keys(updates).join(', ')}`);

                return board.cards[cardIndex];
            }
            return null;
        },

        seedState() {
          console.log('Seeding initial state...');
          const today = dayjs();
          const cards = [
                {id:"lead_1", listId:"novo", name:"João", sobrenome:"Silva", company:"Tech Solutions Ltda", email:"joao@tech.com", phone:"11987654321", origin:"Meta Ads", value:50000, priority:"alta", labels:["Quente","Urgente"], members:["AC"], createdAt:today.startOf('month').add(2, 'day').toISOString(), dueDate: today.endOf('month').toISOString(), nextContactDate: today.add(3, 'day').toISOString(), attributes: [{id: this.uid(), key: "Canal Preferido", value: "WhatsApp"}]},
                {id:"lead_2", listId:"novo", name:"Maria", sobrenome:"Oliveira", company:"Startup XYZ", email:"maria@startupxyz.com", phone:"21998765432", origin:"Google Ads", value:35000, priority:"media", labels:["Novo"], members:["BL"], createdAt:today.startOf('month').add(4, 'day').toISOString(), dueDate: null, nextContactDate: null, attributes: [{id: this.uid(), key: "Canal Preferido", value: ""}]},
                {id:"lead_3", listId:"em-contato", name:"Pedro", sobrenome:"Santos", company:"Indústria ABC", email:"pedro@industriaabc.com", phone:"31912345678", origin:"Indicação", value:120000, priority:"alta", labels:["Corporativo", "Grande Porte"], members:["CS"], createdAt:today.startOf('month').add(5, 'day').toISOString(), dueDate: null, nextContactDate: today.add(1, 'day').toISOString(), attributes: [{id: this.uid(), key: "Canal Preferido", value: ""}]},
                {id:"lead_4", listId:"em-contato", name:"Ana", sobrenome:"Paula", company:"Consultoria Beta", email:"ana@consultoria.com", phone:"41982349876", origin:"Orgânico", value:25000, priority:"baixa", labels:["Pequeno"], members:["AC"], createdAt:today.startOf('month').add(7, 'day').toISOString(), dueDate: null, nextContactDate: null, attributes: [{id: this.uid(), key: "Canal Preferido", value: ""}]},
                {id:"lead_5", listId:"negociacao", name:"Carlos", sobrenome:"Mendes", company:"E-commerce Plus", email:"carlos@ecommerceplus.com", phone:"81981234567", origin:"Meta Ads", value:80000, priority:"media", labels:["E-commerce", "Médio Porte"], members:["BL"], createdAt:today.startOf('month').add(10, 'day').toISOString(), dueDate: null, nextContactDate: null, attributes: [{id: this.uid(), key: "Canal Preferido", value: ""}]},
                {id:"lead_6", listId:"visita", name:"Fernando", sobrenome:"Lima", company:"", email:"fernando@escolamoderna.edu", phone:"47993216543", origin:"Indicação", value:45000, priority:"alta", labels:["Educação"], members:["CS"], createdAt:today.startOf('month').add(12, 'day').toISOString(), dueDate: null, nextContactDate: null, attributes: [{id: this.uid(), key: "Canal Preferido", value: ""}]},
                {id:"lead_7", listId:"proposta", name:"Roberto", sobrenome:"Alves", company:"Logística Express", email:"roberto@logisticaexpress.com", phone:"27987651234", origin:"Google Ads", value:95000, priority:"alta", labels:["Logística", "Grande"], members:["AC"], createdAt:today.startOf('month').add(8, 'day').toISOString(), dueDate: null, nextContactDate: null, attributes: [{id: this.uid(), key: "Canal Preferido", value: ""}]},
                {id:"lead_8", listId:"proposta", name:"Juliana", sobrenome:"Costa", company:"Agência Criativa", email:"juliana@agenciacriativa.com", phone:"41918248614", origin:"Orgânico", value:30000, priority:"media", labels:["Marketing"], members:["BL"], createdAt:today.startOf('month').add(11, 'day').toISOString(), dueDate: null, nextContactDate: null, attributes: [{id: this.uid(), key: "Canal Preferido", value: ""}]},
                {id:"lead_9", listId:"ganhou", name:"Sandra", sobrenome:"Rocha", company:"Construtora Sólida", email:"sandra@construtorasolida.com", phone:"51998234512", origin:"Indicação", value:250000, priority:"alta", labels:["Imobiliário"], members:["CS"], createdAt:today.subtract(1, 'month').add(2, 'day').toISOString(), dueDate: null, nextContactDate: null, attributes: [{id: this.uid(), key: "Canal Preferido", value: ""}]},
              ].map(c => ({...c,
                timeline:[{t:"created",at:c.createdAt}],
                notes: "",
                cidade: "",
                pais: "Brazil",
                biografia: "",
                // Ensure 'attributes' and 'nextContactDate' exist
                attributes: c.attributes || [{id: this.uid(), key: "Canal Preferido", value: ""}],
                nextContactDate: c.nextContactDate || null
              }));

          this.state = {
            preferences: { theme: 'dark', savedViews: [] },
            boards: [{
              id: "leads-br",
              name: "Leads BR",
              availableLabels: ["Quente", "Urgente", "Novo", "Corporativo", "Grande Porte", "Pequeno", "E-commerce", "Médio Porte", "Educação", "Logística", "Marketing", "Imobiliário"],
               availableMembers: [
                   { id: 'AC', name: 'Ana Costa', avatar: 'https://i.pravatar.cc/150?u=AC' },
                   { id: 'BL', name: 'Bruno Lima', avatar: 'https://i.pravatar.cc/150?u=BL' },
                   { id: 'CS', name: 'Carla Souza', avatar: 'https://i.pravatar.cc/150?u=CS' }
               ],
              lists: [
                {id:"novo",name:"Novo",order:0},
                {id:"em-contato",name:"Em Contato",order:1},
                {id:"negociacao",name:"Em Negociação",order:2},
                {id:"visita",name:"Visita Agendada",order:3},
                {id:"proposta",name:"Proposta Enviada",order:4},
                {id:"ganhou",name:"Fechado",order:5},
                {id:"perdido",name:"Perdido",order:6}
              ],
              cards: cards,
            }],
            contacts: cards.map(c => ({...c})),
            automations: [
              {when:"move_to", to:"ganhou", do:"toast", payload:{text:"Lead fechado com sucesso!"}, active: true},
              {when:"create_with_origin", origin:"Meta Ads", do:"assign", payload:{member:"AC"}, active: true}
            ],
            viewState: {
               filters: { origin: [], labels: [], dateRange: { start: null, end: null } },
               sortBy: 'default',
               activeMainView: 'board',
               calendarDataSource: 'nextContactDate' // Set calendar default here
            }
          };

          // Call API PUT
          this.apiPutLeads('Estado inicial (seed)');
        },

        // --- THEME ---
        initTheme() {
          const savedTheme = localStorage.getItem('theme') || 'dark';
          if (savedTheme === 'dark') document.documentElement.classList.add('dark');
          else document.documentElement.classList.remove('dark');
        },
        toggleTheme() {
          document.documentElement.classList.toggle('dark');
          localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        },

        // --- ROUTER ---
        initRouter() {
          window.addEventListener('hashchange', this.handleRouteChange.bind(this));
          this.handleRouteChange();
        },
        handleRouteChange() {
          const hash = window.location.hash || '#/kanban';
          this.closeDrawer();
          this.elements.filterPopup.classList.add('hidden');
           this.hideListActionsDropdown(); // Close dropdown on route change
          document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
          let currentRoute = this.config.routes.find(r => hash.startsWith(r.hash));
          let contactId = null;

          // Logic to get contact ID from URL
          if (currentRoute && currentRoute.hash === '#/contacts' && hash.includes('/')) {
            contactId = hash.split('/')[2];
          }

          if (currentRoute) {
            const viewElement = document.getElementById(currentRoute.view);
            if (viewElement) {
              viewElement.classList.remove('hidden');
              // Dynamic title for contact page - Now in Kanban View header

              if(currentRoute.view === 'kanban-view') {
                this.renderKanbanView(); // Renders board, list, or calendar based on state
                this.renderFilterPopup();
                 // Set H2 title correctly when loading kanban view
                 document.getElementById('view-title').textContent = 'Kanban de Leads';
              }
              // Render contact page if ID exists
              if(currentRoute.view === 'contacts-view') {
                 this.renderContactDetail(contactId);
                   // Set H2 title correctly when loading contacts view
                   document.getElementById('view-title').textContent = contactId ? 'Detalhe do Contato' : 'Contatos';
              }
               // Handle other views' titles
               if (!['kanban-view', 'contacts-view'].includes(currentRoute.view)) {
                 document.getElementById('view-title').textContent = currentRoute.title;
               }


              document.querySelectorAll('#sidebar-nav a').forEach(a => {
                a.classList.toggle('bg-hover', a.getAttribute('href').startsWith(currentRoute.hash));
                a.classList.toggle('text-text', a.getAttribute('href').startsWith(currentRoute.hash));
              });
            } else {
                 console.error(`View element not found for route: ${currentRoute.view}`);
                 window.location.hash = '#/kanban'; // Fallback
            }
          } else {
             window.location.hash = '#/kanban';
          }
        },


        // --- AUTOMATION ---
        runAutomations(type, data) {
          const activeAutomations = this.state.automations.filter(a => a.active);

          activeAutomations.forEach(auto => {
            if (type === 'move_to' && auto.when === 'move_to' && auto.to === data.toList.id) {
              this.executeAutomationAction(auto, data.card);
            }
            if (type === 'create' && auto.when === 'create_with_origin' && auto.origin === data.card.origin) {
              this.executeAutomationAction(auto, data.card);
            }
          });
        },

        executeAutomationAction(automation, card) {
          console.log(`Executing automation: ${automation.do}`, card.name);
          const board = this.state.boards[0];
          const cardIndex = board.cards.findIndex(c => c.id === card.id);

          switch (automation.do) {
            case 'toast':
              this.showToast(automation.payload.text.replace('{name}', card.name), 'success');
              break;
            case 'assign':
               if (cardIndex > -1) {
                 if(!board.cards[cardIndex].members.includes(automation.payload.member)){
                      board.cards[cardIndex].members.push(automation.payload.member);
                      this.showToast(`${card.name} atribuído para ${automation.payload.member}`, 'info');
                 }
               }
              break;
          }
          // Call API PUT
          this.apiPutLeads(`Automação: ${automation.do}`);
        },

        // --- RENDER FUNCTIONS ---
        renderSidebar() {
          this.elements.sidebarNav.innerHTML = this.config.routes.map(route => `
            <a href="${route.hash}" class="flex items-center justify-between px-3 py-2 rounded-lg text-secondary hover:bg-hover hover:text-text font-medium transition-colors">
              <div class="flex items-center">
                <i data-lucide="${route.icon}" class="h-5 w-5 mr-3"></i>
                <span>${route.title}</span>
              </div>
            </a>
          `).join('');
          lucide.createIcons();
        },

        renderKanbanView() {
            const currentView = this.state.viewState.activeMainView;

            // Hide all wrappers first
            this.elements.kanbanBoardWrapper.classList.add('hidden');
            this.elements.listViewWrapper.classList.add('hidden');
            this.elements.calendarWrapper.classList.add('hidden');

            // Reset calendar toggle button
            this.elements.calendarViewToggle.innerHTML = `<i data-lucide="calendar" class="h-4 w-4 mr-2"></i>Calendário`;

            if (currentView === 'board') {
                this.elements.kanbanBoardWrapper.classList.remove('hidden');
                this.elements.mainViewToggle.innerHTML = `<i data-lucide="list" class="h-4 w-4 mr-2"></i>Visão: Lista`;
                this.renderKanbanBoardContent();
            } else if (currentView === 'list') {
                 this.elements.listViewWrapper.classList.remove('hidden');
                 this.elements.mainViewToggle.innerHTML = `<i data-lucide="kanban-square" class="h-4 w-4 mr-2"></i>Visão: Kanban`;
                 this.renderListViewContent();
            } else { // Calendar
                this.elements.calendarWrapper.classList.remove('hidden');
                // Update calendar button text to allow returning
                this.elements.calendarViewToggle.innerHTML = `<i data-lucide="${this.config.previousMainView === 'board' ? 'kanban-square' : 'list'}" class="h-4 w-4 mr-2"></i>Voltar`;
                // Keep the main view toggle as it was
                this.elements.mainViewToggle.innerHTML = `<i data-lucide="${this.config.previousMainView === 'board' ? 'list' : 'kanban-square'}" class="h-4 w-4 mr-2"></i>Visão: ${this.config.previousMainView === 'board' ? 'Lista' : 'Kanban'}`;
                this.renderCalendar();
            }
            lucide.createIcons();
        },

        getProcessedCards() {
             const board = this.state.boards[0];
            const searchTerm = this.elements.globalSearch.value.toLowerCase();
            const { filters, sortBy } = this.state.viewState;

            // Apply search
            let processedCards = searchTerm
                ? board.cards.filter(card => Object.values(card).some(val => String(val).toLowerCase().includes(searchTerm)))
                : [...board.cards];

            // Apply filters
            if (filters.origin.length > 0) {
                processedCards = processedCards.filter(c => filters.origin.includes(c.origin));
            }
            if (filters.labels.length > 0) {
                processedCards = processedCards.filter(c => c.labels.some(l => filters.labels.includes(l)));
            }
            if (filters.dateRange && filters.dateRange.start && filters.dateRange.end) {
                const start = dayjs(filters.dateRange.start).startOf('day');
                const end = dayjs(filters.dateRange.end).endOf('day');
                processedCards = processedCards.filter(c => {
                    // Check if timeline exists and has entries
                    const lastMod = c.timeline && c.timeline.length > 0 ? dayjs(c.timeline[c.timeline.length - 1].at) : dayjs(c.createdAt); // Fallback to createdAt if timeline is empty
                    return lastMod.isBetween(start, end, null, '[]'); // Inclusive check '[]'
                });
            }


             // Apply sorting (for list view primarily, Kanban sorts within columns)
            switch(sortBy) {
                case 'value': processedCards.sort((a, b) => b.value - a.value); break;
                case 'createdAt': processedCards.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)); break; // Data de Criação
                case 'name': processedCards.sort((a, b) => a.name.localeCompare(b.name)); break;
            }

            this.updateFilterIndicator();
            return processedCards;
        },

        renderKanbanBoardContent() {
            const board = this.state.boards[0];
            const lists = [...board.lists].sort((a,b) => a.order - b.order);
            const processedCards = this.getProcessedCards(); // Get filtered/searched cards

            let boardHtml = lists.map(list => {
                let listCards = processedCards.filter(c => c.listId === list.id);
                // Kanban columns don't apply the global sort, only filter/search
                // Sorting within columns is manual via drag-drop

                return `
                  <div class="kanban-list w-[320px] flex-shrink-0 bg-base rounded-2xl flex flex-col relative" data-list-id="${list.id}"> <!-- Added relative positioning -->
                    <div class="p-4 flex items-center justify-between cursor-grab handle">
                      <div class="flex items-center gap-2">
                        <h4 class="font-semibold text-text">${list.name}</h4>
                        <span class="text-sm font-medium text-secondary bg-panel px-2 py-0.5 rounded-md">${listCards.length}</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <button class="add-lead-in-list h-7 w-7 flex items-center justify-center rounded-md text-secondary hover:bg-hover hover:text-text" data-list-id="${list.id}"><i data-lucide="plus" class="h-4 w-4"></i></button>
                        <!-- List actions button -->
                        <button class="list-actions-btn h-7 w-7 flex items-center justify-center rounded-md text-secondary hover:bg-hover hover:text-text" data-list-id="${list.id}"><i data-lucide="more-horizontal" class="h-4 w-4"></i></button>
                      </div>
                    </div>
                    <div class="list-cards flex-1 px-2 pb-2 space-y-3 overflow-y-auto">
                      ${listCards.map(card => this.getCardHtml(card)).join('')}
                    </div>
                  </div>
                `
            }).join('');


            boardHtml += `
              <div class="w-[320px] flex-shrink-0">
                  <button id="add-new-list-btn" class="w-full bg-base/50 text-secondary hover:bg-base hover:text-text transition-colors rounded-2xl p-4 flex items-center justify-center font-semibold">
                     <i data-lucide="plus" class="h-4 w-4 mr-2"></i> Adicionar outra etapa
                  </button>
              </div>
            `;

            this.elements.kanbanBoard.innerHTML = boardHtml;
            const addNewListBtn = document.getElementById('add-new-list-btn');
            if (addNewListBtn) {
              addNewListBtn.addEventListener('click', () => this.showNewListModal());
            }

            lucide.createIcons();
            this.initKanbanSortable();
        },


        renderListViewContent() {
            const processedCards = this.getProcessedCards(); // Get filtered AND sorted cards
            const board = this.state.boards[0];

            this.elements.listViewBody.innerHTML = processedCards.map(card => {
                const list = board.lists.find(l => l.id === card.listId);
                const originColors = { 'Meta Ads': 'bg-blue-500/20 text-blue-400', 'Google Ads': 'bg-green-500/20 text-green-400', 'Orgânico': 'bg-purple-500/20 text-purple-400', 'Indicação': 'bg-yellow-500/20 text-yellow-400', 'Manual': 'bg-gray-500/20 text-gray-400' };

                return `
                  <tr class="list-view-row border-b border-border cursor-pointer" data-card-id="${card.id}">
                      <td class="px-6 py-4 font-medium text-text whitespace-nowrap">${card.name} ${card.sobrenome || ''}</td>
                      <td class="px-6 py-4 text-secondary">${card.company || '-'}</td>
                      <td class="px-6 py-4 text-secondary">${list ? list.name : 'N/A'}</td>
                      <td class="px-6 py-4">
                          <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${originColors[card.origin] || 'bg-gray-500/20 text-gray-400'}">${card.origin}</span>
                      </td>
                      <td class="px-6 py-4">
                          <div class="flex -space-x-2">
                              ${card.members.map(mId => {
                                  const member = board.availableMembers.find(m => m.id === mId);
                                  return member ? `<img class="h-7 w-7 rounded-full border-2 border-panel" src="${member.avatar}" title="${member.name}">` : ''
                              }).join('')}
                          </div>
                      </td>
                       <td class="px-6 py-4 text-secondary">${dayjs(card.createdAt).format('DD/MM/YYYY')}</td>
                      <td class="px-6 py-4 text-right">
                        <!-- Increased message button size -->
                        <button class="card-send-message h-8 w-8 flex-shrink-0 flex items-center justify-center rounded-md text-secondary hover:bg-hover hover:text-text" data-card-id="${card.id}"><i data-lucide="message-circle" class="h-4 w-4"></i></button>
                      </td>
                  </tr>
                `;
            }).join('');
             lucide.createIcons();
        },


        getCardHtml(card) {
          const originColors = { 'Meta Ads': 'bg-blue-500/20 text-blue-400', 'Google Ads': 'bg-green-500/20 text-green-400', 'Orgânico': 'bg-purple-500/20 text-purple-400', 'Indicação': 'bg-yellow-500/20 text-yellow-400', 'Manual': 'bg-gray-500/20 text-gray-400' };
          const board = this.state.boards[0];

          return `
            <div class="kanban-card p-4 bg-panel rounded-xl border border-border shadow-sm cursor-pointer hover:shadow-md hover:border-brand-blue/50 transition-all" data-card-id="${card.id}" draggable="true">
              <div class="flex items-start justify-between mb-2">
                <div>
                    <h5 class="font-semibold text-text mb-1">${card.name} ${card.sobrenome || ''}</h5>
                    <p class="text-sm text-secondary">${card.company || 'Sem empresa'}</p>
                </div>
                <div class="flex-shrink-0 flex items-center">
                    <!-- Increased message button size -->
                    <button class="card-send-message h-8 w-8 flex-shrink-0 flex items-center justify-center rounded-md text-secondary hover:bg-hover hover:text-text" data-card-id="${card.id}" title="Enviar Mensagem"><i data-lucide="message-circle" class="h-4 w-4"></i></button>
                </div>
              </div>

              <div class="flex items-center gap-2 flex-wrap mb-3">
                <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${originColors[card.origin] || 'bg-gray-500/20 text-gray-400'}">${card.origin}</span>
                ${card.labels.map(l => `<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-slate-600 text-slate-200">${l}</span>`).join('')}
              </div>

              <div class="text-sm text-secondary space-y-1.5 mb-4">
                  <div class="flex items-center"><i data-lucide="mail" class="h-4 w-4 mr-2"></i><span>${card.email || '-'}</span></div>
                  <div class="flex items-center"><i data-lucide="phone" class="h-4 w-4 mr-2"></i><span>${card.phone || '-'}</span></div>
              </div>

              <div class="flex items-center justify-between text-sm text-secondary">
                  <div class="flex items-center gap-4">
                    ${card.dueDate ? `<div class="flex items-center"><i data-lucide="calendar" class="h-4 w-4 mr-1.5"></i><span>${dayjs(card.dueDate).format('DD MMM')}</span></div>` : ''}
                    ${card.nextContactDate ? `<div class="flex items-center text-blue-400"><i data-lucide="calendar-check" class="h-4 w-4 mr-1.5"></i><span>${dayjs(card.nextContactDate).format('DD MMM')}</span></div>` : ''}
                  </div>
                  <div class="flex -space-x-2">
                    ${card.members.map(mId => {
                        const member = board.availableMembers.find(m => m.id === mId);
                        return member ? `<img class="h-7 w-7 rounded-full border-2 border-panel" src="${member.avatar}" title="${member.name}">` : ''
                    }).join('')}
                  </div>
              </div>
            </div>
          `;
        },


        renderCalendar() {
            this.elements.calendar.title.textContent = this.config.currentDate.format('MMMM YYYY');
            this.elements.calendar.grid.innerHTML = '';
            this.elements.calendar.gridHeader.innerHTML = '';

            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            this.elements.calendar.gridHeader.innerHTML = dayNames.map(d => `<div class="text-center p-2 text-xs font-bold text-secondary border-b border-border">${d}</div>`).join('');

            const firstDayOfMonth = this.config.currentDate.startOf('month');
            const startDay = firstDayOfMonth.startOf('week');
            const board = this.state.boards[0];
            let currentDay = startDay;

            // Get data source (creation date or next contact)
            const dataSource = this.elements.calendar.calendarDataSource.value || 'nextContactDate'; // Default to nextContactDate if value is missing

            for (let i = 0; i < 35; i++) {
                const isCurrentMonth = currentDay.isSame(this.config.currentDate, 'month');
                const isToday = currentDay.isSame(dayjs(), 'day');

                // Filter cards based on selected data source
                const cardsOnDay = board.cards.filter(c => {
                    const dateToCompare = c[dataSource];
                    return dateToCompare && dayjs(dateToCompare).isSame(currentDay, 'day');
                });

                const dayCell = document.createElement('div');
                dayCell.className = `p-2 overflow-hidden border-r border-b border-border relative ${isCurrentMonth ? 'bg-panel' : 'bg-base'} group transition-colors hover:bg-hover`;
                dayCell.dataset.date = currentDay.format('YYYY-MM-DD');

                dayCell.innerHTML = `
                  <span class="text-sm font-semibold ${isToday ? 'bg-brand-blue text-white rounded-full h-7 w-7 flex items-center justify-center' : (isCurrentMonth ? 'text-text' : 'text-secondary/50')}">${currentDay.format('D')}</span>
                  <div class="cards-container mt-2 space-y-1.5 overflow-y-auto" style="max-height: 80px;">
                      ${cardsOnDay.map(card => `
                          <div class="kanban-card p-1.5 text-xs rounded-md ${dataSource === 'nextContactDate' ? 'bg-blue-600' : 'bg-slate-700'} text-white truncate cursor-pointer hover:bg-slate-600" data-card-id="${card.id}">
                              ${card.name}
                          </div>
                      `).join('')}
                  </div>
                `;
                this.elements.calendar.grid.appendChild(dayCell);
                currentDay = currentDay.add(1, 'day');
            }
            this.initCalendarSortable();
        },

        renderContactDetail(contactId) {
            const viewEl = document.getElementById('contacts-view');
            if (!contactId) {
                // Default 'Contacts' page if no ID selected
                const allContacts = this.state.contacts;
                viewEl.innerHTML = `
                  <div class="bg-panel p-8 rounded-2xl">
                      <h1 class="text-2xl font-bold mb-6">Todos os Contatos (${allContacts.length})</h1>
                      <div class="space-y-3">
                          ${allContacts.map(contact => `
                              <a href="#/contacts/${contact.id}" class="flex items-center p-3 bg-base rounded-lg hover:bg-hover">
                                  <div class="h-10 w-10 rounded-full bg-brand-blue text-white flex items-center justify-center text-xl font-bold mr-4">
                                      ${contact.name.charAt(0)}
                                  </div>
                                  <div>
                                      <p class="font-semibold text-text">${contact.name} ${contact.sobrenome || ''}</p>
                                      <p class="text-sm text-secondary">${contact.company || 'Sem empresa'}</p>
                                  </div>
                              </a>
                          `).join('')}
                      </div>
                  </div>`;
                return;
            }

            const contact = this.state.contacts.find(c => c.id === contactId);
            if(!contact) {
                viewEl.innerHTML = `<div class="bg-panel p-8 rounded-2xl"><h1 class="text-2xl font-bold">Contato não encontrado</h1><p class="text-secondary">O lead pode ter sido excluído. <a href="#/kanban" class="text-brand-blue">Voltar ao Kanban</a></p></div>`;
                return;
            }

            const board = this.state.boards[0];
            const timeSinceCreation = dayjs(contact.createdAt).fromNow();
            // Ensure timeline exists and has entries before accessing the last one
            const lastActivity = contact.timeline && contact.timeline.length > 0
                ? dayjs(contact.timeline[contact.timeline.length - 1].at).fromNow()
                : 'nunca'; // Provide a fallback if timeline is empty

            viewEl.innerHTML = `
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <!-- Left Column (Details) -->
                  <div class="md:col-span-1 space-y-6">
                      <div class="bg-panel p-6 rounded-2xl">
                          <div class="flex flex-col items-center">
                              <div class="h-20 w-20 rounded-full bg-brand-blue text-white flex items-center justify-center text-3xl font-bold mb-4">
                                  ${contact.name.charAt(0)}
                              </div>
                              <h1 class="text-2xl font-bold text-text">${contact.name} ${contact.sobrenome || ''}</h1>
                              <p class="text-sm text-secondary text-center">Criado ${timeSinceCreation} • Última atividade ${lastActivity}</p>
                              <div class="mt-3 flex items-center gap-2 flex-wrap justify-center">
                                  ${contact.labels.map(l => `<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-slate-600 text-slate-200">${l}</span>`).join('')}
                              </div>
                          </div>
                      </div>

                      <div class="bg-panel p-6 rounded-2xl">
                          <h3 class="text-lg font-semibold mb-4">Alterar detalhes do contato</h3>
                          <form id="contact-details-form" class="space-y-4">
                              <div class="grid grid-cols-2 gap-4">
                                  <div>
                                      <label class="text-sm font-medium text-secondary">Nome</label>
                                      <input name="name" value="${contact.name || ''}" class="w-full mt-1 bg-base border border-border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none" />
                                  </div>
                                  <div>
                                      <label class="text-sm font-medium text-secondary">Sobrenome</label>
                                      <input name="sobrenome" value="${contact.sobrenome || ''}" class="w-full mt-1 bg-base border border-border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none" />
                                  </div>
                              </div>
                              <div>
                                  <label class="text-sm font-medium text-secondary">Email</label>
                                  <input name="email" value="${contact.email || ''}" class="w-full mt-1 bg-base border border-border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none" />
                              </div>
                              <div>
                                  <label class="text-sm font-medium text-secondary">Telefone</label>
                                  <input name="phone" value="${contact.phone || ''}" placeholder="Apenas números" class="w-full mt-1 bg-base border border-border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none" />
                              </div>
                              <div>
                                  <label class="text-sm font-medium text-secondary">Empresa</label>
                                  <input name="company" value="${contact.company || ''}" class="w-full mt-1 bg-base border border-border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none" />
                              </div>
                              <button type="submit" class="w-full h-9 px-4 rounded-lg text-sm font-semibold bg-brand-blue text-white hover:bg-blue-700">Salvar Alterações</button>
                          </form>
                      </div>
                  </div>

                  <!-- Right Column (Tabs) -->
                  <div class="md:col-span-2 bg-panel p-6 rounded-2xl">
                      <div class="flex items-center border-b border-border">
                          <button class="contact-tab-btn px-4 py-3 font-semibold border-b-2 border-brand-blue text-text" data-tab="notas">Notas</button>
                          <button class="contact-tab-btn px-4 py-3 font-semibold border-b-2 border-transparent text-secondary hover:text-text" data-tab="data">Próximo Contato</button>
                          <button class="contact-tab-btn px-4 py-3 font-semibold border-b-2 border-transparent text-secondary hover:text-text" data-tab="atributos">Atributos</button>
                          <button class="contact-tab-btn px-4 py-3 font-semibold border-b-2 border-transparent text-secondary hover:text-text" data-tab="historico">Histórico</button>
                      </div>

                      <div id="contact-tab-content" class="mt-6">
                          <!-- Notes Tab -->
                          <div id="tab-notas" class="contact-tab-panel">
                              <h4 class="text-sm font-semibold text-secondary mb-2">Adicionar uma nota</h4>
                              <textarea id="contact-note-textarea" class="w-full h-24 bg-base border border-border rounded-lg p-3 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none" placeholder="Digite sua nota...">${contact.notes || ''}</textarea>
                              <div class="flex justify-end mt-2">
                                  <button id="save-note-btn" class="h-9 px-4 rounded-lg text-sm font-semibold bg-brand-blue text-white hover:bg-blue-700">Salvar nota</button>
                              </div>
                          </div>

                          <!-- Next Contact Tab -->
                          <div id="tab-data" class="contact-tab-panel hidden">
                              <h4 class="text-sm font-semibold text-secondary mb-2">Agendar Próximo Contato</h4>
                              <input id="next-contact-datepicker" type="text" placeholder="Selecione uma data..." class="w-full max-w-sm bg-base border border-border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none" />
                              <div class="flex justify-start mt-2">
                                  <button id="save-next-contact-btn" class="h-9 px-4 rounded-lg text-sm font-semibold bg-brand-blue text-white hover:bg-blue-700">Salvar Data</button>
                              </div>
                          </div>

                          <!-- Attributes Tab -->
                          <div id="tab-atributos" class="contact-tab-panel hidden">
                              <div id="attributes-list" class="space-y-3">
                                  ${contact.attributes.map(attr => `
                                      <div class="grid grid-cols-2 gap-3" data-attr-id="${attr.id}">
                                          <input value="${attr.key}" data-field="key" placeholder="Nome do Atributo (Ex: Canal Preferido)" class="attr-input w-full bg-base border border-border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none" />
                                          <input value="${attr.value}" data-field="value" placeholder="Valor (Ex: WhatsApp)" class="attr-input w-full bg-base border border-border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none" />
                                      </div>
                                  `).join('')}
                              </div>
                              <button id="add-attribute-btn" class="mt-4 h-9 px-4 rounded-lg text-sm font-semibold bg-base text-secondary hover:bg-hover border border-border"><i data-lucide="plus" class="h-4 w-4 inline-block mr-1"></i> Adicionar atributo</button>
                          </div>

                          <!-- History Tab -->
                          <div id="tab-historico" class="contact-tab-panel hidden">
                              <div class="space-y-6">
                              ${[...(contact.timeline || [])].reverse().map(entry => ` <!-- Add check for timeline -->
                                  <div class="flex gap-4">
                                      <div class="h-10 w-10 rounded-full bg-slate-600 flex items-center justify-center flex-shrink-0">
                                          <i data-lucide="${entry.t === 'created' ? 'plus' : (entry.t === 'moved' ? 'move' : (entry.t === 'rescheduled' ? 'calendar-check' : 'pencil'))}" class="h-5 w-5 text-white"></i>
                                      </div>
                                      <div>
                                          <p class="font-medium text-text">${this.getTimelineEntryText(entry, board.lists)}</p>
                                          <p class="text-sm text-secondary">${dayjs(entry.at).format('DD MMM YYYY [às] HH:mm')}</p>
                                      </div>
                                  </div>
                              `).join('')}
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
            `;
            lucide.createIcons();

            // Add Event Listeners for the new Contact Detail page
            this.attachContactDetailListeners(contactId);
        },


        attachContactDetailListeners(contactId, activeTab = 'notas') {
            const contact = this.state.contacts.find(c => c.id === contactId);
            if (!contact) return; // Exit if contact not found

            // Function to set the active tab visually and internally
            const setActiveTab = (tabId) => {
                 document.querySelectorAll('.contact-tab-btn').forEach(b => {
                   const isActive = b.dataset.tab === tabId;
                   b.classList.toggle('border-brand-blue', isActive);
                   b.classList.toggle('text-text', isActive);
                   b.classList.toggle('border-transparent', !isActive);
                   b.classList.toggle('text-secondary', !isActive);
                 });
                 document.querySelectorAll('.contact-tab-panel').forEach(p => p.classList.add('hidden'));
                 const panel = document.getElementById(`tab-${tabId}`);
                 if (panel) panel.classList.remove('hidden');
            };

            // Tab switching listeners
            document.querySelectorAll('.contact-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
            });

             // Set initial active tab
            setActiveTab(activeTab);

            // Save Details Form
            const detailsForm = document.getElementById('contact-details-form');
            if(detailsForm) {
                detailsForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const updates = Object.fromEntries(formData.entries());
                    updates.phone = (updates.phone || '').replace(/\D/g,''); // Clean phone number
                    this.updateCard(contactId, updates); // This will trigger apiPutLeads
                    this.showToast('Contato atualizado!', 'success');
                    // Re-render is handled by apiGetLeads
                });
            }

            // Save Note
            const saveNoteBtn = document.getElementById('save-note-btn');
            if(saveNoteBtn) {
                saveNoteBtn.addEventListener('click', () => {
                    const note = document.getElementById('contact-note-textarea').value;
                    this.updateCard(contactId, { notes: note }); // This will trigger apiPutLeads
                    this.showToast('Nota salva!', 'success');
                });
            }

            // Save "Next Contact"
            const saveNextContactBtn = document.getElementById('save-next-contact-btn');
            if (saveNextContactBtn) {
                saveNextContactBtn.addEventListener('click', () => {
                    const activePicker = this.config.activeLitepicker;
                    const dateVal = activePicker ? activePicker.getDate() : null; // Use active picker

                    if (dateVal) {
                        this.updateCard(contactId, { nextContactDate: dateVal.dateInstance.toISOString() });
                        this.showToast('Próximo contato agendado!', 'success');
                    } else {
                        this.updateCard(contactId, { nextContactDate: null });
                        this.showToast('Agendamento removido.', 'info');
                    }
                 });
             }

            // Initialize Litepicker for "Next Contact"
            if (this.config.activeLitepicker) { // Destroy any active picker first
                this.config.activeLitepicker.destroy();
                this.config.activeLitepicker = null;
            }
            const dateInput = document.getElementById('next-contact-datepicker');
            if(dateInput) { // Only initialize if the field exists
                // Create and store the new picker instance
                this.config.activeLitepicker = new Litepicker({
                    element: dateInput,
                    singleMode: true,
                    autoApply: true,
                    format: 'DD/MM/YYYY',
                    lang: 'pt-br',
                    buttonText: { apply: 'Aplicar', cancel: 'Cancelar' },
                    allowRepick: true, // Allows clicking again to clear
                });
                // Set the existing date if it exists
                if (contact.nextContactDate) {
                    this.config.activeLitepicker.setDate(contact.nextContactDate);
                }
            }


            // Add Attribute
            const addAttrBtn = document.getElementById('add-attribute-btn');
            if(addAttrBtn) {
                addAttrBtn.addEventListener('click', () => {
                     // Ensure attributes array exists
                    if (!contact.attributes) {
                        contact.attributes = [];
                    }
                    const newAttr = { id: this.uid(), key: '', value: '' };
                    contact.attributes.push(newAttr);
                    this.updateCard(contactId, { attributes: contact.attributes }); // This will trigger apiPutLeads
                    // Re-render will happen via apiGetLeads, which calls renderContactDetail again
                });
            }


            // Update Attribute
            document.querySelectorAll('.attr-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const attrRow = e.target.closest('[data-attr-id]');
                    if (!attrRow) return; // Exit if parent not found
                    const attrId = attrRow.dataset.attrId;
                    const field = e.target.dataset.field;
                    const value = e.target.value;

                    // Ensure attributes array exists
                    if (!contact.attributes) {
                       console.error("Contact attributes array is missing.");
                       return;
                    }

                    const attrIndex = contact.attributes.findIndex(a => a.id === attrId);
                    if (attrIndex > -1) {
                        contact.attributes[attrIndex][field] = value;
                        this.updateCard(contactId, { attributes: contact.attributes }); // This will trigger apiPutLeads
                    } else {
                         console.error(`Attribute with id ${attrId} not found.`);
                    }
                 });
             });
        },



        getTimelineEntryText(entry, lists) {
            switch(entry.t) {
                case 'created': return 'Lead criado';
                case 'moved': return `Movido de "${lists.find(l=>l.id===entry.from)?.name || 'N/A'}" para "${lists.find(l=>l.id===entry.to)?.name || 'N/A'}"`;
                case 'edited': return `Campo "${entry.field}" atualizado`;
                case 'rescheduled': return `Próximo contato agendado para ${dayjs(entry.to).format('DD/MM/YYYY')}`;
                default: return 'Atividade registrada';
            }
        },

        renderCardDrawer(card) {
             if (!card) return; // Add null check for card

            const board = this.state.boards[0];
            const availableLabels = board.availableLabels.filter(l => !(card.labels || []).includes(l)); // Add check for card.labels
            const availableMembers = board.availableMembers.filter(m => !(card.members || []).includes(m.id)); // Add check for card.members


            this.elements.cardDrawer.innerHTML = `
              <div class="p-6 border-b border-border flex items-center justify-between">
                   <h3 class="text-2xl font-bold text-text">${card.name || 'Sem nome'}</h3> <!-- Add fallback -->
                   <button id="close-drawer" class="h-8 w-8 flex items-center justify-center rounded-lg text-secondary hover:bg-hover hover:text-text"><i data-lucide="x" class="h-5 w-5"></i></button>
              </div>
              <div class="flex-1 p-6 overflow-y-auto space-y-6">
                  ${this.getDrawerFieldHtml('Nome do Lead', card, 'name', 'text')}
                  ${this.getDrawerFieldHtml('Empresa (Opcional)', card, 'company', 'text')}
                  ${this.getDrawerFieldHtml('E-mail', card, 'email', 'email')}
                  ${this.getDrawerFieldHtml('Telefone (apenas números)', card, 'phone', 'tel')}

                   <div>
                       <label class="text-sm font-medium text-secondary">Responsáveis</label>
                       <div id="drawer-members" class="flex flex-wrap gap-2 mt-2">
                           ${(card.members || []).map(mId => { // Add check for card.members
                               const member = board.availableMembers.find(m => m.id === mId);
                                if (!member) return ''; // Skip if member not found
                               return `
                               <span class="flex items-center gap-1.5 px-2 py-1 text-sm font-semibold rounded-full bg-slate-600 text-slate-200">
                                   <img src="${member.avatar}" class="h-4 w-4 rounded-full" />
                                   ${member.name}
                                   <button class="remove-member-btn" data-member-id="${mId}"><i data-lucide="x" class="h-3 w-3"></i></button>
                               </span>`
                           }).join('')}
                           <div class="relative">
                               <button id="add-member-btn" class="px-2 py-1 text-sm font-semibold rounded-full bg-base hover:bg-hover text-secondary border border-dashed border-border"><i data-lucide="plus" class="h-3 w-3 inline-block"></i> Adicionar</button>
                               <div id="member-dropdown" class="absolute bottom-full mb-2 w-48 bg-panel border border-border rounded-lg shadow-xl p-2 hidden">
                                  ${availableMembers.map(m => `
                                     <button class="w-full text-left px-2 py-1.5 text-sm rounded-md hover:bg-hover flex items-center gap-2 add-member-option" data-member-id="${m.id}">
                                         <img src="${m.avatar}" class="h-5 w-5 rounded-full" /> ${m.name}
                                     </button>
                                  `).join('')}
                               </div>
                           </div>
                       </div>
                    </div>

                   <div>
                       <label class="text-sm font-medium text-secondary">Etiquetas</label>
                       <div id="drawer-labels" class="flex flex-wrap gap-2 mt-2">
                           ${(card.labels || []).map(label => ` <!-- Add check for card.labels -->
                               <span class="flex items-center gap-1.5 px-2 py-1 text-sm font-semibold rounded-full bg-slate-600 text-slate-200">
                                   ${label}
                                   <button class="remove-label-btn" data-label="${label}"><i data-lucide="x" class="h-3 w-3"></i></button>
                               </span>
                           `).join('')}
                           <div class="relative">
                               <button id="add-label-btn" class="px-2 py-1 text-sm font-semibold rounded-full bg-base hover:bg-hover text-secondary border border-dashed border-border"><i data-lucide="plus" class="h-3 w-3 inline-block"></i> Adicionar</button>
                               <div id="label-dropdown" class="absolute bottom-full mb-2 w-48 bg-panel border border-border rounded-lg shadow-xl p-2 hidden">
                                    ${availableLabels.map(l => `<button class="w-full text-left px-2 py-1.5 text-sm rounded-md hover:bg-hover add-label-option" data-label="${l}">${l}</button>`).join('')}
                               </div>
                           </div>
                       </div>
                    </div>
              </div>
            `;
            lucide.createIcons();
        },


        getDrawerFieldHtml(label, card, key, type) {
            return `
              <div class="editable-field" data-key="${key}" data-type="${type}">
                  <label class="text-sm font-medium text-secondary">${label}</label>
                  <p class="text-text text-lg mt-1 cursor-pointer hover:bg-hover p-2 rounded-md">${card[key] || 'Não definido'}</p>
              </div>
            `;
        },

        // --- UI INTERACTION & SORTABLE ---
        openDrawer(cardId) {
          const card = this.state.boards[0].cards.find(c => c.id === cardId);
          if(!card) return;

          this.renderCardDrawer(card);

          this.elements.cardDrawer.dataset.cardId = cardId;
          this.elements.cardDrawer.classList.remove('translate-x-full');
          this.elements.drawerOverlay.classList.remove('hidden');
           // Force reflow
          void this.elements.drawerOverlay.offsetWidth;
          this.elements.drawerOverlay.style.opacity = 1;
        },

        closeDrawer() {
          this.elements.cardDrawer.classList.add('translate-x-full');
          this.elements.drawerOverlay.style.opacity = 0;
          setTimeout(() => this.elements.drawerOverlay.classList.add('hidden'), 300);
          this.elements.cardDrawer.dataset.cardId = '';
        },

        makeFieldEditable(fieldElement) {
          const cardId = this.elements.cardDrawer.dataset.cardId;
          const key = fieldElement.dataset.key;
          const type = fieldElement.dataset.type;

          const card = this.state.boards[0].cards.find(c => c.id === cardId);
          if (!card) return;

          const currentValue = card[key];
          const p = fieldElement.querySelector('p');
           // If p is already replaced, exit
           if (!p) return;


          const input = document.createElement('input');
          input.type = type;
          input.value = currentValue || '';
          input.className = "w-full bg-base border border-border rounded-lg px-3 py-2 text-lg focus:ring-2 focus:ring-brand-blue focus:outline-none";

          p.replaceWith(input);
          input.focus();

          const save = () => {
              let newValue = type === 'number' ? parseFloat(input.value) || 0 : input.value;
              if (type === 'tel') {
                   newValue = newValue.replace(/\D/g,''); // Remove non-digits for phone
              }

              // Only update if value changed
              if (newValue !== currentValue) {
                this.updateCard(cardId, { [key]: newValue }); // This will trigger apiPutLeads
                this.showToast('Informação salva!', 'success');
              }


              const newP = document.createElement('p');
              newP.className = "text-text text-lg mt-1 cursor-pointer hover:bg-hover p-2 rounded-md";
              newP.textContent = newValue || 'Não definido';

              // Check if input is still in the DOM before replacing
               if (input.parentNode === fieldElement) {
                 input.replaceWith(newP);
               }

              // Re-render is handled by apiGetLeads
          };

          // Use 'blur' event for saving
           input.addEventListener('blur', save);
           input.addEventListener('keydown', (e) => {
               if (e.key === 'Enter') {
                 e.preventDefault(); // Prevent form submission if applicable
                 input.blur(); // Trigger blur to save
               }
               if (e.key === 'Escape') {
                  input.value = currentValue; // Revert value
                  input.blur(); // Trigger blur (which will now save the original value)
               }
           });

        },


        initKanbanSortable() {
          const boardEl = this.elements.kanbanBoard;
          if (!boardEl) return; // Add check

          // Destroy existing Sortable instance if it exists
          if (boardEl.sortableInstance) {
              boardEl.sortableInstance.destroy();
          }

          boardEl.sortableInstance = new Sortable(boardEl, { // Store instance
              animation: 150, ghostClass: 'sortable-ghost', handle: '.handle',
              onEnd: (evt) => {
                  const board = this.state.boards[0];
                  // Check if lists array exists and has elements
                  if (!board || !board.lists || board.lists.length === 0) return;

                   // Ensure oldIndex and newIndex are within bounds
                   if (evt.oldIndex < 0 || evt.oldIndex >= board.lists.length || evt.newIndex < 0) return;


                  const [movedList] = board.lists.splice(evt.oldIndex, 1);
                   // Ensure movedList is defined
                  if (!movedList) return;

                  board.lists.splice(evt.newIndex, 0, movedList);
                  board.lists.forEach((list, index) => list.order = index);
                  // Call API PUT
                  this.apiPutLeads('Movimentação de coluna');
              },
          });

          document.querySelectorAll('.list-cards').forEach(listEl => {
             // Destroy existing Sortable instance if it exists
             if (listEl.sortableInstance) {
                 listEl.sortableInstance.destroy();
             }
             listEl.sortableInstance = new Sortable(listEl, { // Store instance
                 group: 'cards', animation: 150, ghostClass: 'sortable-ghost',
                 onEnd: (evt) => {
                     const cardId = evt.item.dataset.cardId;
                     const fromListEl = evt.from.closest('.kanban-list');
                     const toListEl = evt.to.closest('.kanban-list');

                     // Add checks for elements and dataset
                     if (!fromListEl || !toListEl || !fromListEl.dataset.listId || !toListEl.dataset.listId) return;

                     const fromListId = fromListEl.dataset.listId;
                     const toListId = toListEl.dataset.listId;

                     const board = this.state.boards[0];
                     const card = board.cards.find(c => c.id === cardId);

                     if (card && fromListId !== toListId) {
                         card.listId = toListId;
                         // Ensure timeline exists
                          if (!card.timeline) card.timeline = [];
                         card.timeline.push({ t: "moved", from: fromListId, to: toListId, at: new Date().toISOString() });

                         const toList = board.lists.find(l => l.id === toListId);
                         if (toList) { // Check if toList exists
                           this.runAutomations('move_to', { card, toList });
                         }

                         // Call API PUT
                         this.apiPutLeads(`Movimentação de lead: ${card.name}`);
                     }
                 },
             });
          });
        },


        initCalendarSortable() {
            document.querySelectorAll('#calendar-grid .cards-container').forEach(container => {
                // Destroy existing Sortable instance if it exists
                 if (container.sortableInstance) {
                     container.sortableInstance.destroy();
                 }
                 container.sortableInstance = new Sortable(container, { // Store instance
                    group: 'calendar-cards',
                    animation: 150,
                    onEnd: (evt) => {
                        const cardId = evt.item.dataset.cardId;
                        const dateEl = evt.to.closest('[data-date]');
                         // Add checks for elements and dataset
                         if (!dateEl || !dateEl.dataset.date) return;

                        const newDate = dateEl.dataset.date;
                        const dataSource = this.elements.calendar.calendarDataSource.value || 'nextContactDate';

                        const board = this.state.boards[0];
                        const cardIndex = board.cards.findIndex(c => c.id === cardId);

                        if(cardIndex !== -1 && newDate) {
                            const oldDate = board.cards[cardIndex][dataSource];
                            board.cards[cardIndex][dataSource] = dayjs(newDate).toISOString(); // Save in correct date

                            // Add to timeline
                            const eventType = dataSource === 'nextContactDate' ? 'rescheduled' : 'edited';
                            const fieldName = dataSource === 'nextContactDate' ? 'Próximo Contato' : 'Data de Criação';
                             // Ensure timeline exists
                             if (!board.cards[cardIndex].timeline) board.cards[cardIndex].timeline = [];

                            board.cards[cardIndex].timeline.push({ t: eventType, from: oldDate, to: newDate, at: new Date().toISOString(), field: fieldName });

                            // Call API PUT
                            this.apiPutLeads(`Reagendamento de lead: ${board.cards[cardIndex].name}`);
                            this.showToast(`Lead ${board.cards[cardIndex].name} movido para ${dayjs(newDate).format('DD/MM')}`, 'info');
                        }
                    }
                });
            });
        },


        // --- FILTERS & SORTING ---
        renderFilterPopup() {
             if (!this.state.viewState || !this.state.boards || !this.state.boards[0]) return; // Add checks

            const { filters, sortBy } = this.state.viewState;
            const board = this.state.boards[0];
             // Ensure cards array exists before mapping
            const allOrigins = [...new Set((board.cards || []).map(c => c.origin))];
            const allLabels = board.availableLabels || [];


            this.elements.filterPopup.innerHTML = `
              <div class="space-y-4">
                  <div>
                      <h4 class="text-sm font-semibold text-secondary mb-2">Ordenar por</h4>
                      <select id="sort-select" class="w-full bg-base border border-border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none">
                          <option value="default" ${sortBy === 'default' ? 'selected' : ''}>Padrão</option>
                          <option value="value" ${sortBy === 'value' ? 'selected' : ''}>Maior Valor</option>
                          <option value="createdAt" ${sortBy === 'createdAt' ? 'selected' : ''}>Data de Criação</option>
                          <option value="name" ${sortBy === 'name' ? 'selected' : ''}>Ordem Alfabética</option>
                      </select>
                  </div>
                  <div class="border-t border-border"></div>
                  <div>
                      <h4 class="text-sm font-semibold text-secondary mb-2">Data de Alteração</h4>
                      <input id="filter-date-range" type="text" placeholder="Selecione um intervalo" class="w-full bg-base border border-border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand-blue focus:outline-none" />
                  </div>
                  <div class="border-t border-border"></div>
                  <div>
                      <h4 class="text-sm font-semibold text-secondary mb-2">Origem</h4>
                      <div id="origin-filters" class="space-y-1">
                          ${allOrigins.map(o => `
                              <label class="flex items-center space-x-2 cursor-pointer">
                                  <input type="checkbox" value="${o}" class="form-checkbox h-4 w-4 rounded text-brand-blue bg-base border-border focus:ring-brand-blue" ${filters.origin.includes(o) ? 'checked' : ''}>
                                  <span class="text-sm">${o}</span>
                              </label>
                          `).join('')}
                      </div>
                  </div>
                   <div class="border-t border-border"></div>
                   <div>
                      <h4 class="text-sm font-semibold text-secondary mb-2">Etiquetas</h4>
                      <div id="label-filters" class="space-y-1 max-h-32 overflow-y-auto">
                         ${allLabels.map(l => `
                              <label class="flex items-center space-x-2 cursor-pointer">
                                  <input type="checkbox" value="${l}" class="form-checkbox h-4 w-4 rounded text-brand-blue bg-base border-border focus:ring-brand-blue" ${filters.labels.includes(l) ? 'checked' : ''}>
                                  <span class="text-sm">${l}</span>
                              </label>
                         `).join('')}
                      </div>
                   </div>
                  <div class="border-t border-border pt-4 flex justify-between items-center">
                      <button id="clear-filters-btn" class="text-sm text-secondary hover:text-text">Limpar Filtros</button>
                  </div>
              </div>
            `;
            this.initFilterDatepicker();
        },


        initFilterDatepicker() {
            if (this.config.activeLitepicker) {
              try { this.config.activeLitepicker.destroy(); } catch (e) { console.warn("Error destroying previous Litepicker:", e); }
              this.config.activeLitepicker = null;
            }
            const dateInput = document.getElementById('filter-date-range');
            if(!dateInput) return; // Exit if input doesn't exist

            this.config.activeLitepicker = new Litepicker({
                element: dateInput,
                singleMode: false,
                autoApply: true,
                format: 'DD/MM/YYYY',
                lang: 'pt-br',
                buttonText: { apply: 'Aplicar', cancel: 'Cancelar' },
                dropdowns: {
                    minYear: 2020,
                    maxYear: null,
                    months: true,
                    years: true,
                },
                setup: (picker) => {
                    picker.on('selected', (date1, date2) => {
                        // Ensure dates are valid before setting state
                        if (date1 && date2) {
                          this.state.viewState.filters.dateRange = { start: date1.dateInstance.toISOString(), end: date2.dateInstance.toISOString() }; // Store as ISO strings
                          // Call API PUT
                          this.apiPutLeads('Alteração de filtro de data');
                        } else {
                           // Handle case where selection might be cleared or invalid
                           this.state.viewState.filters.dateRange = { start: null, end: null };
                           this.apiPutLeads('Limpeza de filtro de data');
                        }
                    });
                     // Add event listener for clearing
                     picker.on('clear:selection', () => {
                         this.state.viewState.filters.dateRange = { start: null, end: null };
                         dateInput.value = ''; // Clear input value as well
                         this.apiPutLeads('Limpeza de filtro de data');
                     });
                }
            });

            const { dateRange } = this.state.viewState.filters;
             // Ensure dateRange and its properties exist before setting
            if(dateRange && dateRange.start && dateRange.end) {
               // Convert ISO strings back to Date objects for setDateRange
               try {
                   this.config.activeLitepicker.setDateRange(new Date(dateRange.start), new Date(dateRange.end));
               } catch (e) {
                   console.error("Error setting date range in Litepicker:", e);
                   dateInput.value = ''; // Clear input if dates are invalid
               }
             } else {
                 dateInput.value = ''; // Clear input if no range is set
             }
        },


        updateFilterIndicator() {
             const { filters } = this.state.viewState;
             const isActive = filters.origin.length > 0 || filters.labels.length > 0 || (filters.dateRange && filters.dateRange.start);
             this.elements.filterIndicator.classList.toggle('hidden', !isActive);
        },

        // --- MODAL & TOASTS ---
        showToast(message, type = 'success') {
          const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
          const icons = { success: 'check-circle', error: 'alert-circle', info: 'info' };
          const toast = document.createElement('div');
          toast.className = `flex items-center gap-3 px-4 py-3 rounded-lg text-white text-sm font-semibold shadow-lg transition-all duration-300 transform translate-y-10 opacity-0 ${colors[type]}`;
          toast.innerHTML = `<i data-lucide="${icons[type]}" class="h-5 w-5"></i><span>${message}</span>`;
          this.elements.toastContainer.appendChild(toast);
          lucide.createIcons();
          setTimeout(() => toast.classList.remove('translate-y-10', 'opacity-0'), 10);
          setTimeout(() => {
              toast.classList.add('opacity-0');
              toast.addEventListener('transitionend', () => toast.remove());
          }, 3000);
        },

        showModal(config) {
            const { title, content, onConfirm, confirmText = 'Confirmar', confirmClass = 'bg-red-600 hover:bg-red-700', showCancel = true } = config; // Added showCancel
            this.elements.modalBox.innerHTML = `
              <h3 class="text-xl font-bold mb-2">${title}</h3>
              <div class="text-secondary mb-6">${content}</div>
              <div class="flex justify-end gap-3">
                  ${showCancel ? `<button id="modal-cancel" class="h-9 px-4 rounded-lg text-sm font-semibold bg-panel border border-border hover:bg-hover">Cancelar</button>` : ''}
                  ${onConfirm ? `<button id="modal-confirm" class="h-9 px-4 rounded-lg text-sm font-semibold text-white ${confirmClass}">${confirmText}</button>` : ''}
              </div>
            `;
            this.elements.modalOverlay.classList.remove('hidden');
             // Force reflow to ensure transition works
            void this.elements.modalOverlay.offsetWidth;
            this.elements.modalOverlay.style.opacity = 1;
            this.elements.modalBox.style.transform = 'scale(1)';

            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            // Store bound functions to remove them later
            const closeModalHandler = () => this.closeModal();
            const confirmHandler = () => {
                if (onConfirm) onConfirm();
                this.closeModal();
            };
            const overlayClickHandler = (e) => {
                if (e.target === this.elements.modalOverlay) this.closeModal();
            };

            // Assign handlers
            if (confirmBtn) confirmBtn.onclick = confirmHandler;
            if (cancelBtn) cancelBtn.onclick = closeModalHandler;
            this.elements.modalOverlay.onclick = overlayClickHandler;

             // Store handlers on the element to remove later
             this.elements.modalOverlay._closeModalHandler = closeModalHandler;
             this.elements.modalOverlay._confirmHandler = confirmHandler;
             this.elements.modalOverlay._overlayClickHandler = overlayClickHandler;

        },

        closeModal() {
            // Remove event listeners before hiding
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            if (confirmBtn && this.elements.modalOverlay._confirmHandler) confirmBtn.onclick = null;
            if (cancelBtn && this.elements.modalOverlay._closeModalHandler) cancelBtn.onclick = null;
            if (this.elements.modalOverlay._overlayClickHandler) this.elements.modalOverlay.onclick = null;

            // Clear stored handlers
            this.elements.modalOverlay._closeModalHandler = null;
            this.elements.modalOverlay._confirmHandler = null;
            this.elements.modalOverlay._overlayClickHandler = null;

            // Animate out
            this.elements.modalOverlay.style.opacity = 0;
            this.elements.modalBox.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.elements.modalOverlay.classList.add('hidden');
                this.elements.modalBox.innerHTML = ''; // Clear content after hiding
            }, 300);
        },


        // Logs Modal
        showLogsModal() {
            const logsHtml = this.logs.length > 0
                ? [...this.logs].reverse().map(log => {
                    const time = dayjs(log.time).format('HH:mm:ss');
                    const color = log.type === 'error' ? 'text-red-400' : (log.type === 'success' ? 'text-green-400' : 'text-slate-400');
                    const icon = log.type === 'error' ? 'alert-circle' : (log.type === 'success' ? 'check-circle' : 'arrow-right-circle');
                    return `<div class="flex items-center gap-2 ${color}">
                                <i data-lucide="${icon}" class="h-3 w-3 flex-shrink-0"></i>
                                <span class="text-xs mr-1">[${time}]</span>
                                <span class="text-sm">${log.message}</span>
                            </div>`;
                }).join('')
                : '<p class="text-secondary">Nenhum log registrado.</p>';

            const content = `<div id="logs-content-area" class="w-full h-80 overflow-y-auto bg-base p-3 rounded-lg border border-border space-y-2">${logsHtml}</div>`;

            this.showModal({
                title: 'Logs do Sistema',
                content: content,
                confirmText: 'Limpar Logs',
                confirmClass: 'bg-yellow-600 hover:bg-yellow-700',
                onConfirm: () => {
                    this.logs = [];
                    this.addLog('Logs limpos.', 'info');
                    // No need to call showLogsModal again, renderLogsInModal will update if modal stays open
                    this.renderLogsInModal(); // Immediately update the content
                }
            });
            lucide.createIcons();
        },


        // Render logs in modal if open
        renderLogsInModal() {
            const modalArea = document.getElementById('logs-content-area');
            if (modalArea && !this.elements.modalOverlay.classList.contains('hidden')) { // Check if modal is open
                 const logsHtml = this.logs.length > 0
                     ? [...this.logs].reverse().map(log => {
                         const time = dayjs(log.time).format('HH:mm:ss');
                         const color = log.type === 'error' ? 'text-red-400' : (log.type === 'success' ? 'text-green-400' : 'text-slate-400');
                         const icon = log.type === 'error' ? 'alert-circle' : (log.type === 'success' ? 'check-circle' : 'arrow-right-circle');
                         return `<div class="flex items-center gap-2 ${color}">
                                     <i data-lucide="${icon}" class="h-3 w-3 flex-shrink-0"></i>
                                     <span class="text-xs mr-1">[${time}]</span>
                                     <span class="text-sm">${log.message}</span>
                                 </div>`;
                     }).join('')
                     : '<p class="text-secondary">Nenhum log registrado.</p>';
                 modalArea.innerHTML = logsHtml;
                 lucide.createIcons();
            }
        },

        // Function now creates lead and redirects
        createNewLeadAndRedirect(listId = 'novo') {
            const newCard = {
                id: this.uid(),
                listId,
                name: 'Novo Lead',
                sobrenome: '',
                company: '',
                value: 0,
                email: '',
                phone: '',
                origin: 'Manual',
                priority: 'media',
                labels: [],
                members: ['AC'], // Default member
                createdAt: new Date().toISOString(),
                dueDate: null,
                nextContactDate: null,
                checklist: [], // Keep checklist array, even if empty
                timeline: [{ t: "created", at: new Date().toISOString() }],
                notes: "",
                attributes: [{id: this.uid(), key: "Canal Preferido", value: ""}],
                cidade: "",
                pais: "Brazil",
                biografia: ""
            };
            this.state.boards[0].cards.push(newCard);
            this.state.contacts.push({...newCard}); // Add to contacts as well

            this.apiPutLeads('Criação de novo lead');
            this.showToast('Novo lead criado. Preencha os detalhes.', 'success');

            // Redirect to detail page
            window.location.hash = `#/contacts/${newCard.id}`;
        },


        showNewListModal() {
            const content = `<form id="new-list-form"><label class="text-sm font-medium text-secondary">Nome da Etapa</label><input name="name" required class="w-full mt-1 bg-base border border-border rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-blue focus:outline-none" /></form>`;
            this.showModal({
                title: 'Criar Nova Etapa', content, confirmText: 'Criar Etapa', confirmClass: 'bg-brand-blue hover:bg-blue-700',
                onConfirm: () => {
                    const form = document.getElementById('new-list-form');
                    const nameInput = form.querySelector('input[name="name"]'); // Get input element
                    const name = nameInput ? nameInput.value.trim() : null; // Get trimmed value
                    if (!name) {
                         this.showToast('Nome da etapa não pode ser vazio.', 'error');
                         // Re-show modal or highlight input if needed
                          nameInput?.classList.add('border-red-500'); // Example: highlight error
                         return; // Prevent closing modal
                    };
                    const board = this.state.boards[0];
                    const newListId = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''); // Sanitize ID

                     // Check if list ID already exists
                     if (board.lists.some(list => list.id === newListId)) {
                         this.showToast(`Etapa com ID '${newListId}' já existe. Escolha um nome diferente.`, 'error');
                         nameInput?.classList.add('border-red-500');
                         this.showNewListModal(); // Re-show the modal keeping the input value
                         const existingInput = document.getElementById('new-list-form')?.querySelector('input[name="name"]');
                         if(existingInput) existingInput.value = name; // Restore value
                         return; // Prevent closing original modal
                     }


                    const newList = { id: newListId, name: name, order: board.lists.length };
                    board.lists.push(newList);

                    this.apiPutLeads('Criação de nova etapa');
                    this.showToast('Nova etapa criada!', 'success');
                    // Modal closes automatically via confirmHandler
                }
            });
             // Focus the input when the modal appears
             setTimeout(() => {
                 const input = document.getElementById('new-list-form')?.querySelector('input[name="name"]');
                 input?.focus();
             }, 100); // Small delay for modal transition
        },


        // Added "Preferred Channel" logic
        showSendMessageModal(card) {
             if (!card || !card.attributes) return; // Add checks
            const preferredChannelAttr = card.attributes.find(a => a.key === 'Canal Preferido');
            const preferredChannel = preferredChannelAttr ? preferredChannelAttr.value : null;

            if (preferredChannel === 'WhatsApp' && card.phone) {
                window.open(`https://wa.me/${card.phone || ''}`, '_blank');
                this.showToast(`Abrindo WhatsApp para ${card.name}`, 'info');
                return; // Skip modal
            }
            if (preferredChannel === 'Instagram') {
                window.open(`https://ig.me/m/USUARIO_INSTA_MOCK`, '_blank'); // Mock link
                this.showToast(`Abrindo Instagram para ${card.name}`, 'info');
                return; // Skip modal
            }

            // Original modal logic
            const content = `
              <p class="text-secondary mb-4">Para qual canal você deseja enviar uma mensagem para ${card.name}?</p>
              <div class="space-y-3">
                  <a href="https://wa.me/${card.phone || ''}" target="_blank" class="flex items-center gap-3 p-3 bg-base rounded-lg hover:bg-hover">
                      <i data-lucide="message-circle" class="h-5 w-5 text-green-500"></i>
                      <span>WhatsApp</span>
                  </a>
                  <a href="https://ig.me/m/USUARIO_INSTA_MOCK" target="_blank" class="flex items-center gap-3 p-3 bg-base rounded-lg hover:bg-hover">
                      <i data-lucide="instagram" class="h-5 w-5 text-pink-500"></i>
                      <span>Instagram DM</span>
                  </a>
              </div>
            `;
            this.showModal({
                title: 'Enviar Mensagem',
                content: content,
                 showCancel: false // No need for cancel button here
            });
            lucide.createIcons();
        },

        // --- List Actions ---
        showListActionsDropdown(buttonElement, listId) {
            this.hideListActionsDropdown(); // Close any existing dropdown

            const rect = buttonElement.getBoundingClientRect();
            const dropdown = document.createElement('div');
            dropdown.className = 'list-actions-dropdown'; // Use existing style
            dropdown.style.left = `${rect.left}px`;
            dropdown.style.top = `${rect.bottom + window.scrollY + 4}px`; // Position below button
            dropdown.dataset.listId = listId; // Store listId

            dropdown.innerHTML = `
                <button class="w-full text-left px-2 py-1.5 text-sm rounded-md hover:bg-hover list-rename-btn">
                    <i data-lucide="pencil" class="h-3 w-3 inline-block mr-2"></i>Renomear
                </button>
                <button class="w-full text-left px-2 py-1.5 text-sm rounded-md hover:bg-hover text-red-500 list-delete-btn">
                     <i data-lucide="trash-2" class="h-3 w-3 inline-block mr-2"></i>Excluir
                 </button>
            `;

            this.elements.listActionsContainer.appendChild(dropdown);
            lucide.createIcons();
            this.config.openListActionsDropdown = dropdown; // Track the open dropdown

            // Add listeners for the new buttons
            dropdown.querySelector('.list-rename-btn').addEventListener('click', () => {
                this.showRenameListModal(listId);
                this.hideListActionsDropdown();
            });
            dropdown.querySelector('.list-delete-btn').addEventListener('click', () => {
                this.confirmDeleteList(listId);
                this.hideListActionsDropdown();
            });
        },

        hideListActionsDropdown() {
            if (this.config.openListActionsDropdown) {
                this.config.openListActionsDropdown.remove();
                this.config.openListActionsDropdown = null;
            }
        },

        showRenameListModal(listId) {
            const list = this.state.boards[0].lists.find(l => l.id === listId);
            if (!list) return;

            const content = `
                <form id="rename-list-form">
                    <label class="text-sm font-medium text-secondary">Novo nome da Etapa</label>
                    <input name="name" required class="w-full mt-1 bg-base border border-border rounded-lg px-3 py-2 focus:ring-2 focus:ring-brand-blue focus:outline-none" value="${list.name}" />
                 </form>
            `;
            this.showModal({
                title: 'Renomear Etapa', content, confirmText: 'Salvar', confirmClass: 'bg-brand-blue hover:bg-blue-700',
                onConfirm: () => {
                    const form = document.getElementById('rename-list-form');
                     const nameInput = form.querySelector('input[name="name"]');
                     const newName = nameInput ? nameInput.value.trim() : null;

                    if (!newName) {
                         this.showToast('Nome da etapa não pode ser vazio.', 'error');
                         nameInput?.classList.add('border-red-500');
                         // Re-show modal keeping value
                         this.showRenameListModal(listId);
                         const existingInput = document.getElementById('rename-list-form')?.querySelector('input[name="name"]');
                         if(existingInput) existingInput.value = newName || list.name; // Restore value or original
                         return;
                    }
                     // Check if name is unchanged
                     if (newName === list.name) {
                         this.closeModal(); // Just close if name hasn't changed
                         return;
                     }

                    const listIndex = this.state.boards[0].lists.findIndex(l => l.id === listId);
                    if (listIndex > -1) {
                        this.state.boards[0].lists[listIndex].name = newName;
                        this.apiPutLeads('Renomear etapa');
                        this.showToast('Etapa renomeada!', 'success');
                    }
                     // Modal closes automatically
                }
            });
             // Focus and select text
             setTimeout(() => {
                 const input = document.getElementById('rename-list-form')?.querySelector('input[name="name"]');
                 input?.focus();
                 input?.select();
             }, 100);
        },

        confirmDeleteList(listId) {
            const list = this.state.boards[0].lists.find(l => l.id === listId);
            if (!list) return;

            // Count cards in the list
             const cardsInList = this.state.boards[0].cards.filter(c => c.listId === listId).length;
             let warningMessage = `Tem certeza que deseja excluir a etapa "${list.name}"?`;
             if (cardsInList > 0) {
                 warningMessage += ` ${cardsInList} lead${cardsInList > 1 ? 's' : ''} nesta etapa ${cardsInList > 1 ? 'serão afetados' : 'será afetado'} (não ${cardsInList > 1 ? 'serão' : 'será'} mais exibido${cardsInList > 1 ? 's' : ''} no quadro).`;
             }
             warningMessage += ' Esta ação é irreversível.';


            this.showModal({
                title: 'Excluir Etapa?',
                content: warningMessage,
                confirmText: 'Excluir',
                confirmClass: 'bg-red-600 hover:bg-red-700',
                onConfirm: () => {
                    const listIndex = this.state.boards[0].lists.findIndex(l => l.id === listId);
                    if (listIndex > -1) {
                        this.state.boards[0].lists.splice(listIndex, 1);
                         // Note: Cards in this list are now orphaned but remain in the main cards array.
                         // They won't render in the board view unless moved or logic is added.
                         this.addLog(`Etapa "${list.name}" (${listId}) excluída. ${cardsInList} cards órfãos.`, 'info');
                        this.apiPutLeads('Excluir etapa');
                        this.showToast(`Etapa "${list.name}" excluída.`, 'info');
                    }
                }
            });
        },


        // --- EVENT LISTENERS ---
        attachEventListeners() {
          this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());
          this.elements.drawerOverlay.addEventListener('click', () => this.closeDrawer());
          this.elements.addNewLeadHeaderBtn.addEventListener('click', () => this.createNewLeadAndRedirect());
          this.elements.refreshDataBtn.addEventListener('click', () => this.apiGetLeads('Atualização manual'));
          this.elements.showLogsBtn.addEventListener('click', () => this.showLogsModal());

           // Main View Toggle (Board/List)
           this.elements.mainViewToggle.addEventListener('click', () => {
             const currentView = this.state.viewState.activeMainView;
             if (currentView === 'board' || currentView === 'list') {
                 this.state.viewState.activeMainView = currentView === 'board' ? 'list' : 'board';
                 this.config.previousMainView = this.state.viewState.activeMainView; // Update previous view
             } else { // If on calendar, just switch main view state without rendering yet
                 this.state.viewState.activeMainView = this.config.previousMainView === 'board' ? 'list' : 'board';
                 this.config.previousMainView = this.state.viewState.activeMainView;
             }
              this.apiPutLeads('Troca de visão (kanban/lista)');
           });

           // Calendar View Toggle
           this.elements.calendarViewToggle.addEventListener('click', () => {
             const currentView = this.state.viewState.activeMainView;
             if (currentView === 'calendar') {
                 this.state.viewState.activeMainView = this.config.previousMainView;
             } else {
                 this.config.previousMainView = currentView;
                 this.state.viewState.activeMainView = 'calendar';
             }
              this.apiPutLeads('Troca de visão (calendário)');
           });

          this.elements.filterBtn.addEventListener('click', (e) => {
             e.stopPropagation();
              this.hideListActionsDropdown(); // Close list actions if open
             this.elements.filterPopup.classList.toggle('hidden');
             if(!this.elements.filterPopup.classList.contains('hidden')) {
                 this.initFilterDatepicker();
             }
          });

          this.elements.filterPopup.addEventListener('change', (e) => {
             if (e.target.id === 'sort-select') {
                 this.state.viewState.sortBy = e.target.value;
             }
             if (e.target.closest('#origin-filters')) {
                 this.state.viewState.filters.origin = [...document.querySelectorAll('#origin-filters input:checked')].map(el => el.value);
             }
              if (e.target.closest('#label-filters')) {
                 this.state.viewState.filters.labels = [...document.querySelectorAll('#label-filters input:checked')].map(el => el.value);
              }
              this.apiPutLeads('Alteração de filtro/ordem');
          });

          this.elements.filterPopup.addEventListener('click', (e) => {
             e.stopPropagation(); // Prevents popup from closing itself
             if(e.target.id === 'clear-filters-btn') {
                 this.state.viewState.filters = { origin: [], labels: [], dateRange: { start: null, end: null } };
                 this.state.viewState.sortBy = 'default';
                  // Safely try to clear Litepicker selection
                  try {
                       if (this.config.activeLitepicker) this.config.activeLitepicker.clearSelection();
                       const dateInput = document.getElementById('filter-date-range');
                       if (dateInput) dateInput.value = ''; // Also clear input field
                  } catch(err) { console.warn("Error clearing Litepicker:", err); }

                 this.apiPutLeads('Limpeza de filtros');
                 this.renderFilterPopup(); // Re-render the popup with cleared values
             }
          });


          // Global click listener to close popups
          document.addEventListener('click', (e) => {
             // Close Filter Popup
             if (this.elements.filterPopup && !this.elements.filterPopup.classList.contains('hidden') && !this.elements.filterPopup.contains(e.target) && !this.elements.filterBtn.contains(e.target)) {
                 this.elements.filterPopup.classList.add('hidden');
             }
              // Close List Actions Dropdown
              if (this.config.openListActionsDropdown && !this.config.openListActionsDropdown.contains(e.target) && !e.target.closest('.list-actions-btn')) {
                  this.hideListActionsDropdown();
              }
               // Close Label/Member dropdowns in drawer
              const labelDropdown = document.getElementById('label-dropdown');
              const memberDropdown = document.getElementById('member-dropdown');
              if (labelDropdown && !labelDropdown.classList.contains('hidden') && !labelDropdown.contains(e.target) && !e.target.closest('#add-label-btn')) {
                  labelDropdown.classList.add('hidden');
              }
               if (memberDropdown && !memberDropdown.classList.contains('hidden') && !memberDropdown.contains(e.target) && !e.target.closest('#add-member-btn')) {
                   memberDropdown.classList.add('hidden');
               }
          });


          this.elements.cardDrawer.addEventListener('click', (e) => {
             if (e.target.closest('#close-drawer')) this.closeDrawer();
             const field = e.target.closest('.editable-field p');
             if (field) this.makeFieldEditable(field.parentElement);

             // Label Logic
             const addLabelBtn = e.target.closest('#add-label-btn');
             const labelDropdown = document.getElementById('label-dropdown');
             if(addLabelBtn && labelDropdown) labelDropdown.classList.toggle('hidden');

             const addLabelOption = e.target.closest('.add-label-option');
             if(addLabelOption && labelDropdown) {
                 const cardId = this.elements.cardDrawer.dataset.cardId;
                 const card = this.state.boards[0].cards.find(c => c.id === cardId);
                  if (card) {
                     if (!card.labels) card.labels = []; // Ensure labels array exists
                     card.labels.push(addLabelOption.dataset.label);
                     this.updateCard(cardId, { labels: card.labels });
                  }
                 labelDropdown.classList.add('hidden'); // Close dropdown after selection
             }
             const removeLabelBtn = e.target.closest('.remove-label-btn');
             if(removeLabelBtn) {
                 const cardId = this.elements.cardDrawer.dataset.cardId;
                 const card = this.state.boards[0].cards.find(c => c.id === cardId);
                  if (card && card.labels) { // Check labels exist
                     const newLabels = card.labels.filter(l => l !== removeLabelBtn.dataset.label);
                     this.updateCard(cardId, { labels: newLabels });
                  }
             }

             // Member Logic
             const addMemberBtn = e.target.closest('#add-member-btn');
              const memberDropdown = document.getElementById('member-dropdown');
             if(addMemberBtn && memberDropdown) memberDropdown.classList.toggle('hidden');

             const addMemberOption = e.target.closest('.add-member-option');
             if(addMemberOption && memberDropdown) {
                 const cardId = this.elements.cardDrawer.dataset.cardId;
                 const card = this.state.boards[0].cards.find(c => c.id === cardId);
                  if (card) {
                     if (!card.members) card.members = []; // Ensure members array exists
                     card.members.push(addMemberOption.dataset.memberId);
                     this.updateCard(cardId, { members: card.members });
                  }
                 memberDropdown.classList.add('hidden'); // Close dropdown
             }
             const removeMemberBtn = e.target.closest('.remove-member-btn');
             if(removeMemberBtn) {
                 const cardId = this.elements.cardDrawer.dataset.cardId;
                 const card = this.state.boards[0].cards.find(c => c.id === cardId);
                  if (card && card.members) { // Check members exist
                     const newMembers = card.members.filter(m => m !== removeMemberBtn.dataset.memberId);
                     this.updateCard(cardId, { members: newMembers });
                  }
             }
          });


          // Delegated event listener for dynamic content in viewsContainer
          this.elements.viewsContainer.addEventListener('click', (e) => {
              const cardElement = e.target.closest('.kanban-card, .list-view-row');
              const addLeadBtn = e.target.closest('.add-lead-in-list');
              const sendMessageBtn = e.target.closest('.card-send-message');
              const listActionsBtn = e.target.closest('.list-actions-btn'); // New

              if (listActionsBtn) { // Handle list actions button click
                  e.stopPropagation();
                  const listId = listActionsBtn.dataset.listId;
                  this.showListActionsDropdown(listActionsBtn, listId);
              } else if (sendMessageBtn) {
                  e.stopPropagation();
                  const cardId = sendMessageBtn.closest('[data-card-id]')?.dataset.cardId;
                  if (cardId) {
                      const card = this.state.boards[0].cards.find(c => c.id === cardId);
                      if (card) this.showSendMessageModal(card);
                  }
              } else if (cardElement && cardElement.dataset.cardId) {
                  // Navigate to contact detail from Kanban card, List view row, or Calendar card
                  window.location.hash = `#/contacts/${cardElement.dataset.cardId}`;
              } else if (addLeadBtn && addLeadBtn.dataset.listId) {
                  this.createNewLeadAndRedirect(addLeadBtn.dataset.listId);
              }
              // Clicking anywhere else in viewsContainer that isn't handled above might close popups via the global listener
          });


          this.elements.globalSearch.addEventListener('input', (e) => this.renderKanbanView()); // Re-render on search input
          document.addEventListener('keydown', (e) => {
              if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                  e.preventDefault();
                   if (this.elements.globalSearch) this.elements.globalSearch.focus(); // Add check
              }
              if (e.key === 'Escape') {
                  this.closeDrawer();
                  this.elements.filterPopup.classList.add('hidden');
                   this.hideListActionsDropdown(); // Close dropdown on escape
              }
          });

          // Listener for calendar data source selector
          this.elements.calendar.calendarDataSource.addEventListener('change', (e) => {
             this.state.viewState.calendarDataSource = e.target.value; // Save selection to state
             this.apiPutLeads('Mudança de fonte de dados do calendário'); // Save state change
          });

          this.elements.calendar.prevBtn.addEventListener('click', () => {
              this.config.currentDate = this.config.currentDate.subtract(1, 'month');
              this.renderCalendar(); // Only re-render calendar part
          });
          this.elements.calendar.nextBtn.addEventListener('click', () => {
              this.config.currentDate = this.config.currentDate.add(1, 'month');
              this.renderCalendar(); // Only re-render calendar part
          });
          this.elements.calendar.todayBtn.addEventListener('click', () => {
              this.config.currentDate = dayjs();
              this.renderCalendar(); // Only re-render calendar part
          });
        }
      };

      App.init();

    };
  </script>

</body>

</html>
